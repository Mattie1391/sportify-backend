<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Upload to Mux with UpChunk</title>
    <script src="https://unpkg.com/@mux/upchunk"></script>
  </head>
  <body>
    <h1>å½±ç‰‡ä¸Šå‚³</h1>
    <input type="file" id="videoInput" accept="video/*" />
    <button id="uploadBtn">ä¸Šå‚³å½±ç‰‡</button>
    <progress id="progressBar" max="100" value="0"></progress>
    <p id="status"></p>

    <script>
      document.getElementById("uploadBtn").addEventListener("click", async () => {
        const file = document.getElementById("videoInput").files[0];
        if (!file) return alert("è«‹é¸æ“‡å½±ç‰‡");

        const filename = file.name;
        const extension = filename.split(".").pop();
        const size = file.size;

        //æ¸¬è©¦ç”¨çš„ç« ç¯€ã€å°ç¯€å‡è³‡æ–™ã€‚
        const fakeChapter = {
          subChapterId: "00199d82-8e51-49bd-9780-2f5f989087cd", //æ–°å»ºç«‹çš„å°ç¯€æœƒæ²’æœ‰id
        };

        // å¾å¾Œç«¯å–å¾— direct_upload urlï¼Œå¾reså–å¾—ä¸Šå‚³url
        //ç¶²å€å¯«æ­»ï¼ŒPORTè«‹ç¤ºæƒ…æ³æ”¹å¯«æˆå¦‚3000
        //æ¨¡æ“¬å‰ç«¯å‚³é€è«‹æ±‚
        const res = await fetch("http://localhost:8080/api/v1/mux/upload-url", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            //æ¸¬è©¦æ™‚è«‹ç”¨POSTMAN ç”Ÿæˆæ–°æ•™ç·´TOKENå†è²¼ä¸Šä¾†
            Authorization: `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjUzMjg3ZTFjLWM5ZWEtNGQ1OS1iYzAyLTY1ZWZiYjMxMGNlNiIsInJvbGUiOiJDT0FDSCIsImlhdCI6MTc1MDE2ODkyMSwiZXhwIjoxNzUyNzYwOTIxfQ.mp43s_7Sggxo4j0ydoP-VlcWplsbWllwG9yfE0o7LsY`,
          },
          body: JSON.stringify({
            subChapterId: fakeChapter.subChapterId,
            extension,
            size,
          }),
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(`å–å¾— upload URL å¤±æ•—: ${error.message || res.status}`);
        }
        const data = await res.json();
        const uploadUrl = data.url;

        if (!uploadUrl) {
          throw new Error("å¾Œç«¯æœªå›å‚³ä¸Šå‚³ URL");
        }

        const upload = UpChunk.createUpload({
          endpoint: uploadUrl, // Mux æä¾›çš„ direct upload URL
          file: file,
          chunkSize: 2048, // KB (2MB per chunk)ï¼Œè¼ƒå°å°æ–¼åŒæ­¥ä¸Šå‚³è€Œè¨€è¼ƒç©©å®šï¼Œå¤§é‡å½±ç‰‡ä¸€èµ·ä¸Šå‚³æ™‚è¦–æƒ…æ³å¯ä»¥è¨­å®šåˆ°5MB
        });

        upload.on("error", (err) => {
          document.getElementById("status").innerText = `âŒ éŒ¯èª¤: ${err.detail}`;
        });

        upload.on("progress", (progress) => {
          document.getElementById("progressBar").value = progress.detail;
          document.getElementById("status").innerText = `ğŸ“¤ ä¸Šå‚³ä¸­: ${progress.detail.toFixed(2)}%`;
        });

        upload.on("success", () => {
          document.getElementById("status").innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
        });
      });
    </script>
  </body>
</html>
